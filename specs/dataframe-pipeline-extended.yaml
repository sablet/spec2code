version: "1"
meta:
  name: "dataframe-pipeline-extended"
  description: "DataFrame pipeline with configurable transform selection modes"

checks:
  - id: check_step_a
    description: "Step A DataFrame validation"
    impl: "apps.dataframe-pipeline-extended.checks.dataframe_checks:check_step_a"
    file_path: "checks/dataframe_checks.py"

  - id: check_normalized
    description: "Normalized DataFrame validation"
    impl: "apps.dataframe-pipeline-extended.checks.dataframe_checks:check_normalized"
    file_path: "checks/dataframe_checks.py"

  - id: check_step_b
    description: "Step B DataFrame validation"
    impl: "apps.dataframe-pipeline-extended.checks.dataframe_checks:check_step_b"
    file_path: "checks/dataframe_checks.py"

examples:
  - id: ex_step_a
    description: "Step A example row"
    input:
      timestamp: "2024-01-01"
      value: 100
    expected:
      valid: true

  - id: ex_normalized_minmax
    description: "MinMax normalized example row"
    input:
      timestamp: "2024-01-01"
      value: 100
      normalized: 0.0
    expected:
      valid: true

  - id: ex_step_b
    description: "Step B row with features"
    input:
      timestamp: "2024-01-01"
      value: 100
      normalized: 0.0
      rolling_mean: 100.0
    expected:
      valid: true

datatypes:
  - id: StepAFrame
    description: "Step A output DataFrame (raw values)"
    check_ids:
      - check_step_a
    example_ids:
      - ex_step_a
    schema:
      type: object
      properties:
        timestamp:
          type: string
          format: date
        value:
          type: number
      required:
        - timestamp
        - value

  - id: NormalizedFrame
    description: "Normalized DataFrame (with normalized column)"
    check_ids:
      - check_normalized
    example_ids:
      - ex_normalized_minmax
    schema:
      type: object
      properties:
        timestamp:
          type: string
          format: date
        value:
          type: number
        normalized:
          type: number
      required:
        - timestamp
        - value
        - normalized

  - id: StepBFrame
    description: "Step B output DataFrame (with additional features)"
    check_ids:
      - check_step_b
    example_ids:
      - ex_step_b
    schema:
      type: object
      properties:
        timestamp:
          type: string
          format: date
        value:
          type: number
        normalized:
          type: number
        rolling_mean:
          type: number
        diff:
          type: number
        lag_1:
          type: number
      required:
        - timestamp
        - value
        - normalized

transforms:
  # Normalization候補（排他的選択: 3つから1つ必須）
  - id: normalize_minmax
    description: "MinMax normalization (0-1 scaling)"
    impl: "apps.dataframe-pipeline-extended.transforms.normalization:normalize_minmax"
    file_path: "transforms/normalization.py"
    parameters:
      - name: data
        datatype_ref: StepAFrame
        native: "pandas:DataFrame"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  - id: normalize_zscore
    description: "Z-score normalization (mean=0, std=1)"
    impl: "apps.dataframe-pipeline-extended.transforms.normalization:normalize_zscore"
    file_path: "transforms/normalization.py"
    parameters:
      - name: data
        datatype_ref: StepAFrame
        native: "pandas:DataFrame"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  - id: normalize_robust
    description: "Robust normalization (median/IQR based)"
    impl: "apps.dataframe-pipeline-extended.transforms.normalization:normalize_robust"
    file_path: "transforms/normalization.py"
    parameters:
      - name: data
        datatype_ref: StepAFrame
        native: "pandas:DataFrame"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  # Feature Engineering候補（複数選択: N個から1個以上）
  - id: add_rolling_mean
    description: "Add rolling mean feature (window=2)"
    impl: "apps.dataframe-pipeline-extended.transforms.features:add_rolling_mean"
    file_path: "transforms/features.py"
    parameters:
      - name: data
        datatype_ref: NormalizedFrame
        native: "pandas:DataFrame"
      - name: window
        datatype_ref: null
        native: "builtins:int"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  - id: add_diff
    description: "Add difference feature (current - previous)"
    impl: "apps.dataframe-pipeline-extended.transforms.features:add_diff"
    file_path: "transforms/features.py"
    parameters:
      - name: data
        datatype_ref: NormalizedFrame
        native: "pandas:DataFrame"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  - id: add_lag_features
    description: "Add lag features (previous N values)"
    impl: "apps.dataframe-pipeline-extended.transforms.features:add_lag_features"
    file_path: "transforms/features.py"
    parameters:
      - name: data
        datatype_ref: NormalizedFrame
        native: "pandas:DataFrame"
      - name: n_lags
        datatype_ref: null
        native: "builtins:int"
    return_datatype_ref: NormalizedFrame
    return_native: "pandas:DataFrame"

  # 最終出力（候補1つのみ: 自動選択）
  - id: finalize_step_b
    description: "Finalize to Step B format"
    impl: "apps.dataframe-pipeline-extended.transforms.output:finalize_step_b"
    file_path: "transforms/output.py"
    parameters:
      - name: data
        datatype_ref: NormalizedFrame
        native: "pandas:DataFrame"
    return_datatype_ref: StepBFrame
    return_native: "pandas:DataFrame"

# Traditional DAG format (for skeleton generation compatibility)
dag:
  - from: normalize_minmax
    to: add_rolling_mean
  - from: normalize_minmax
    to: add_diff
  - from: normalize_minmax
    to: add_lag_features
  - from: normalize_zscore
    to: add_rolling_mean
  - from: normalize_zscore
    to: add_diff
  - from: normalize_zscore
    to: add_lag_features
  - from: normalize_robust
    to: add_rolling_mean
  - from: normalize_robust
    to: add_diff
  - from: normalize_robust
    to: add_lag_features
  - from: add_rolling_mean
    to: finalize_step_b
  - from: add_diff
    to: finalize_step_b
  - from: add_lag_features
    to: finalize_step_b

# Extended DAG format (for config-based execution)
dag_stages:
  - stage_id: "normalization"
    description: "Choose normalization method"
    selection_mode: "exclusive"  # 3つから1つ必須
    input_type: StepAFrame
    output_type: NormalizedFrame
    candidates:
      - transform_id: normalize_minmax
      - transform_id: normalize_zscore
      - transform_id: normalize_robust

  - stage_id: "feature_engineering"
    description: "Select feature engineering transforms"
    selection_mode: "multiple"   # N個から1個以上選択可
    min_select: 1
    max_select: null  # null = unlimited
    input_type: NormalizedFrame
    output_type: NormalizedFrame
    candidates:
      - transform_id: add_rolling_mean
        default_params:
          window: 2
      - transform_id: add_diff
      - transform_id: add_lag_features
        default_params:
          n_lags: 1

  - stage_id: "output"
    description: "Finalize output format"
    selection_mode: "single"     # 候補1つ（従来通り）
    input_type: NormalizedFrame
    output_type: StepBFrame
    candidates:
      - transform_id: finalize_step_b
